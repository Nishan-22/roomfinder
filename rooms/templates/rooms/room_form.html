{% extends "base.html" %}
{% block title %}{{ form.instance.pk|yesno:"Refine Listing,List Your Space" }} | RoomFinder{% endblock %}

{% block content %}
<div id="scroll-progress" class="fixed top-[73px] left-0 h-1 bg-blue-600 z-[60] transition-all duration-300" style="width: 0%"></div>

<div class="max-w-4xl mx-auto px-4 py-16 animate-fade-in">

    <div class="mb-16 text-center">
        <span class="inline-block py-1 px-4 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs font-black uppercase tracking-widest mb-4">
            Property Portal
        </span>
        <h2 class="text-5xl font-black tracking-tight text-gray-900 dark:text-white">
            {{ form.instance.pk|yesno:"Refine Listing,List Your Space" }}
        </h2>
        <p class="text-gray-500 dark:text-gray-400 mt-4 text-lg font-medium">Capture the details that make your space unique.</p>
    </div>

    <form method="POST" enctype="multipart/form-data" class="space-y-12">
        {% csrf_token %}

        {% if form.errors %}
        <div class="p-6 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded-2xl animate-pulse">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                <strong class="text-red-800 dark:text-red-300">Validation Error</strong>
            </div>
            <ul class="list-disc list-inside text-sm text-red-700 dark:text-red-400">
                {% for field in form %}{% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}{% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="card">
            <div class="flex items-center space-x-4 mb-8">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 dark:shadow-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                </div>
                <h3 class="text-2xl font-black tracking-tight dark:text-white">The Essentials</h3>
            </div>
            
            <div class="grid gap-6 custom-form">
                <div class="field-group">
                    <label>Property Title</label>
                    {{ form.title }}
                </div>
                <div class="field-group">
                    <label>Description</label>
                    {{ form.description }}
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field-group"><label>Property Type</label>{{ form.property_type }}</div>
                    <div class="field-group"><label>Room Type</label>{{ form.room_type }}</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center space-x-4 mb-8">
                <div class="w-12 h-12 bg-emerald-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-200 dark:shadow-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <h3 class="text-2xl font-black tracking-tight dark:text-white">Value & Location</h3>
            </div>
            
            <div class="grid gap-6 custom-form">
                <div class="field-group"><label>Precise Location</label>{{ form.location }}</div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field-group"><label>Monthly Price</label>{{ form.price }}</div>
                    <div class="field-group"><label>Availability Date</label>{{ form.available_from }}</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center space-x-4 mb-8">
                <div class="w-12 h-12 bg-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-purple-200 dark:shadow-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </div>
                <h3 class="text-2xl font-black tracking-tight dark:text-white">Gallery</h3>
            </div>

            <div class="space-y-6">
                <div class="p-6 bg-gray-50 dark:bg-gray-900/50 rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-800">
                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Main Cover Photo</label>
                    {{ form.image }}
                </div>

                <div class="p-6 bg-gray-50 dark:bg-gray-900/50 rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-800">
                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Add Gallery Images</label>
                    <input type="file" name="gallery_images" id="gallery-input" multiple accept="image/*" class="file-input w-full">
                    <div id="preview-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4 mt-6"></div>
                </div>

                {% if form.instance.pk and form.instance.images.all %}
                <div class="pt-6 border-t border-gray-100 dark:border-gray-800">
                    <p class="font-black text-sm text-gray-400 uppercase tracking-widest mb-4">Manage Gallery</p>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                        {% for img in form.instance.images.all %}
                        <label class="relative group cursor-pointer aspect-square overflow-hidden rounded-xl">
                            <img src="{{ img.image.url }}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <input type="checkbox" name="delete_images" value="{{ img.id }}" class="absolute top-2 right-2 w-5 h-5 accent-red-600 rounded">
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="flex items-center space-x-4 mb-8">
                <div class="w-12 h-12 bg-orange-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-orange-200 dark:shadow-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </div>
                <h3 class="text-2xl font-black tracking-tight dark:text-white">Host Information</h3>
            </div>
            <div class="grid md:grid-cols-2 gap-6 custom-form">
                <div class="field-group"><label>Full Name</label>{{ form.owner_name }}</div>
                <div class="field-group"><label>Direct Phone</label>{{ form.contact_number }}</div>
            </div>
        </div>

        <button type="submit" class="submit-btn hover:-translate-y-1 active:scale-95">
            {{ form.instance.pk|yesno:"Save Changes,Publish Property" }}
        </button>
    </form>
</div>

<style>
    .card { background: white; padding: 2.5rem; border-radius: 2.5rem; border: 1px solid #f1f5f9; transition: all 0.3s ease; }
    .dark .card { background: #0f172a; border-color: #1e293b; }
    
    .field-group label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; margin-bottom: 0.6rem; padding-left: 0.5rem; }
    
    /* ðŸŽ¨ THE FIX: Improved visibility and focus states */
    .custom-form input, .custom-form textarea, .custom-form select { 
        width: 100%; padding: 1.1rem; border-radius: 1.25rem; 
        background: #f8fafc; border: 2px solid transparent; 
        transition: all 0.2s ease; color: #1e293b; outline: none; font-weight: 600;
    }

    .dark .custom-form input, .dark .custom-form textarea, .dark .custom-form select { 
        background: #1e293b; color: #f8fafc; 
    }

    /* Keep background consistent when typing to prevent "white-out" */
    .custom-form input:focus, .custom-form textarea:focus { 
        border-color: #2563eb; 
        background: #ffffff; 
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); 
    }

    .dark .custom-form input:focus, .dark .custom-form textarea:focus { 
        background: #1e293b; /* Stays dark in dark mode */
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .submit-btn {
        width: 100%; padding: 1.5rem; font-weight: 900; background: #2563eb; 
        color: white; border-radius: 2rem; font-size: 1.25rem; box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.3); transition: all 0.3s;
    }

    .thumb-preview { height: 90px; width: 100%; object-fit: cover; border-radius: 1rem; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
</style>

<script>
    // Preview Gallery Images
    document.getElementById('gallery-input').addEventListener('change', function(e) {
        const grid = document.getElementById('preview-grid');
        grid.innerHTML = '';
        [...e.target.files].forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.className = "thumb-preview animate-fade-in";
                grid.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    });

    // Scroll Progress Bar
    window.addEventListener('scroll', () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        document.getElementById('scroll-progress').style.width = scrolled + "%";
    });
</script>
{% endblock %}